"use client";

import { useEffect, useState } from "react";
import { createClient } from "@/lib/supabase/client";
import { useAuth } from "@/app/context/AuthContext";
import Link from "next/link";
import { Plus, Edit2, Trash2, Calendar, DollarSign, Save } from "lucide-react";

// === TYPER ===
interface BoardingPrice {
  id: string;
  org_id: string;
  dog_size: "small" | "medium" | "large";
  base_price: number;
  weekend_surcharge: number;
  is_active: boolean;
  created_at: string;
  updated_at?: string;
}

interface SpecialDate {
  id: string;
  org_id: string;
  date: string;
  name: string;
  category: "red_day" | "holiday" | "event" | "custom";
  price_surcharge: number;
  notes?: string;
  is_active: boolean;
  created_at: string;
}

interface BoardingSeason {
  id: string;
  org_id: string;
  name: string;
  start_date: string;
  end_date: string;
  price_multiplier: number;
  priority: number;
  is_active: boolean;
  created_at: string;
}

type SizeCategory = "small" | "medium" | "large";

const SIZE_LABELS: Record<SizeCategory, string> = {
  small: "Liten (<35 cm)",
  medium: "Mellan (35-54 cm)",
  large: "Stor (>54 cm)",
};

const SIZE_RANGES: Record<SizeCategory, string> = {
  small: "<35 cm",
  medium: "35-54 cm",
  large: ">54 cm",
};

export default function PriserPage() {
  const supabase = createClient();
  const { user, currentOrgId, loading: authLoading } = useAuth();
  const [prices, setPrices] = useState<BoardingPrice[]>([]);
  const [seasons, setSeasons] = useState<BoardingSeason[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  // Edit states
  const [editingPrice, setEditingPrice] = useState<BoardingPrice | null>(null);
  const [editingSeason, setEditingSeason] = useState<BoardingSeason | null>(
    null
  );

  // === LADDA DATA ===
  useEffect(() => {
    if (!authLoading && currentOrgId) {
      loadData();
    }
  }, [authLoading, currentOrgId]);

  async function loadData() {
    if (!currentOrgId) return;

    setLoading(true);
    setError(null);

    try {
      const [pricesRes, seasonsRes] = await Promise.all([
        (supabase as any)
          .from("boarding_prices")
          .select("*")
          .eq("org_id", currentOrgId)
          .order("created_at", { ascending: false }),

        (supabase as any)
          .from("boarding_seasons")
          .select("*")
          .eq("org_id", currentOrgId)
          .order("start_date", { ascending: true }),
      ]);

      if (pricesRes.error) throw pricesRes.error;
      if (seasonsRes.error) throw seasonsRes.error;

      setPrices(pricesRes.data || []);
      setSeasons(seasonsRes.data || []);
    } catch (err: any) {
      console.error("Fel vid laddning:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }

  // === SPARA PRIS ===
  async function savePrice(price: Partial<BoardingPrice>) {
    if (!currentOrgId) return;

    setError(null);
    setSuccess(null);

    try {
      if (price.id) {
        // Uppdatera
        const { error } = await (supabase as any)
          .from("boarding_prices")
          .update({
            size_category: price.size_category,
            base_price: price.base_price,
            weekend_multiplier: price.weekend_multiplier,
            holiday_multiplier: price.holiday_multiplier,
            high_season_multiplier: price.high_season_multiplier,
          })
          .eq("id", price.id);

        if (error) throw error;
        setSuccess("Pris uppdaterat!");
      } else {
        // Skapa nytt
        const { error } = await (supabase as any)
          .from("boarding_prices")
          .insert({
            org_id: currentOrgId,
            size_category: price.size_category,
            base_price: price.base_price || 300,
            weekend_multiplier: price.weekend_multiplier || 1.2,
            holiday_multiplier: price.holiday_multiplier || 1.5,
            high_season_multiplier: price.high_season_multiplier || 1.3,
          });

        if (error) throw error;
        setSuccess("Pris skapat!");
      }

      setEditingPrice(null);
      loadData();
    } catch (err: any) {
      console.error("Fel vid sparande:", err);
      setError(err.message);
    }
  }

  // === SPARA S√ÑSONG ===
  async function saveSeason(season: Partial<BoardingSeason>) {
    if (!currentOrgId) return;

    setError(null);
    setSuccess(null);

    try {
      if (season.id) {
        // Uppdatera
        const { error } = await (supabase as any)
          .from("boarding_seasons")
          .update({
            name: season.name,
            start_date: season.start_date,
            end_date: season.end_date,
            type: season.type,
          })
          .eq("id", season.id);

        if (error) throw error;
        setSuccess("S√§song uppdaterad!");
      } else {
        // Skapa ny
        const { error } = await (supabase as any)
          .from("boarding_seasons")
          .insert({
            org_id: currentOrgId,
            name: season.name,
            start_date: season.start_date,
            end_date: season.end_date,
            type: season.type || "high",
          });

        if (error) throw error;
        setSuccess("S√§song skapad!");
      }

      setEditingSeason(null);
      loadData();
    } catch (err: any) {
      console.error("Fel vid sparande:", err);
      setError(err.message);
    }
  }

  // === RADERA ===
  async function deletePrice(id: string) {
    if (!confirm("√Ñr du s√§ker p√• att du vill radera detta pris?")) return;

    try {
      const { error } = await (supabase as any)
        .from("boarding_prices")
        .delete()
        .eq("id", id);

      if (error) throw error;
      setSuccess("Pris raderat!");
      loadData();
    } catch (err: any) {
      setError(err.message);
    }
  }

  async function deleteSeason(id: string) {
    if (!confirm("√Ñr du s√§ker p√• att du vill radera denna s√§song?")) return;

    try {
      const { error } = await (supabase as any)
        .from("boarding_seasons")
        .delete()
        .eq("id", id);

      if (error) throw error;
      setSuccess("S√§song raderad!");
      loadData();
    } catch (err: any) {
      setError(err.message);
    }
  }

  if (authLoading || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#2c7a4c] mr-4"></div>
        <p>Laddar priser...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header med Hunddagis-struktur */}
      <div className="border-b border-gray-200 bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <div className="flex justify-between items-start">
            <div className="flex-1">
              <h1 className="text-[32px] font-bold text-[#2c7a4c] leading-tight flex items-center gap-2">
                üí∞ Priser & S√§songer
              </h1>
              <p className="mt-1 text-base text-gray-600">
                Hantera grundpriser per storlek och s√§songstill√§gg f√∂r
                pensionatet
              </p>
            </div>
            <div className="flex gap-3 ml-4">
              <div className="bg-white rounded-lg px-4 py-2 border border-gray-200 shadow-sm">
                <div className="text-xs text-gray-600">Prismodeller</div>
                <div className="text-xl font-bold text-[#2c7a4c]">
                  {prices.length}
                </div>
              </div>
              <div className="bg-white rounded-lg px-4 py-2 border border-gray-200 shadow-sm">
                <div className="text-xs text-gray-600">S√§songer</div>
                <div className="text-xl font-bold text-[#2c7a4c]">
                  {seasons.length}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto px-6 py-6">
        {/* Back button */}
        <div className="mb-6">
          <Link
            href="/hundpensionat"
            className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors font-semibold text-sm"
          >
            ‚Üê Tillbaka
          </Link>
        </div>

        {/* Status messages */}
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6 text-sm">
            {error}
          </div>
        )}
        {success && (
          <div className="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-6 text-sm">
            {success}
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* PRISER */}
          <div>
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                  <DollarSign className="text-[#2c7a4c]" size={20} />
                  Grundpriser
                </h2>
                <button
                  onClick={() =>
                    setEditingPrice({
                      id: "",
                      org_id: "",
                      size_category: "medium",
                      base_price: 300,
                      weekend_multiplier: 1.2,
                      holiday_multiplier: 1.5,
                      high_season_multiplier: 1.3,
                      created_at: "",
                    })
                  }
                  className="flex items-center gap-2 px-4 py-2 bg-[#2c7a4c] text-white rounded-md hover:bg-[#236139] transition-colors font-semibold text-sm"
                >
                  <Plus size={16} />
                  L√§gg till
                </button>
              </div>

              {prices.length === 0 ? (
                <p className="text-gray-500 py-8 text-sm">
                  Inga priser √§nnu. Klicka p√• "L√§gg till" f√∂r att skapa.
                </p>
              ) : (
                <div className="space-y-4">
                  {prices.map((price) => (
                    <div
                      key={price.id}
                      className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors"
                    >
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <h3 className="font-semibold text-gray-900 text-sm">
                            {price.size_category
                              ? SIZE_LABELS[price.size_category]
                              : "Allm√§nt"}
                          </h3>
                          <p className="text-sm text-gray-600">
                            Grundpris: {price.base_price} kr/natt
                          </p>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setEditingPrice(price)}
                            className="p-2 text-blue-600 hover:bg-blue-50 rounded-md"
                          >
                            <Edit2 size={16} />
                          </button>
                          <button
                            onClick={() => deletePrice(price.id)}
                            className="p-2 text-red-600 hover:bg-red-50 rounded-md"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                      <div className="grid grid-cols-3 gap-2 text-sm">
                        <div className="bg-orange-50 px-2 py-1 rounded-md">
                          <div className="text-gray-600 text-xs">Helg</div>
                          <div className="font-semibold text-gray-900">
                            {Math.round(
                              price.base_price * price.weekend_multiplier
                            )}{" "}
                            kr
                          </div>
                          <div className="text-xs text-gray-500">
                            ({price.weekend_multiplier}x)
                          </div>
                        </div>
                        <div className="bg-red-50 px-2 py-1 rounded-md">
                          <div className="text-gray-600 text-xs">H√∂gtid</div>
                          <div className="font-semibold text-gray-900">
                            {Math.round(
                              price.base_price * price.holiday_multiplier
                            )}{" "}
                            kr
                          </div>
                          <div className="text-xs text-gray-500">
                            ({price.holiday_multiplier}x)
                          </div>
                        </div>
                        <div className="bg-yellow-50 px-2 py-1 rounded-md">
                          <div className="text-gray-600 text-xs">
                            H√∂gss√§song
                          </div>
                          <div className="font-semibold text-gray-900">
                            {Math.round(
                              price.base_price * price.high_season_multiplier
                            )}{" "}
                            kr
                          </div>
                          <div className="text-xs text-gray-500">
                            ({price.high_season_multiplier}x)
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Edit Form */}
              {editingPrice && (
                <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <h3 className="font-semibold mb-4 text-sm">
                    {editingPrice.id ? "Redigera pris" : "Nytt pris"}
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">
                        Storlek
                      </label>
                      <select
                        value={editingPrice.size_category || ""}
                        onChange={(e) =>
                          setEditingPrice({
                            ...editingPrice,
                            size_category: e.target.value as SizeCategory,
                          })
                        }
                        className="w-full px-3 py-2 border rounded-md text-sm"
                      >
                        <option value="">V√§lj storlek</option>
                        {Object.entries(SIZE_LABELS).map(([key, label]) => (
                          <option key={key} value={key}>
                            {label}
                          </option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">
                        Grundpris (kr/natt)
                      </label>
                      <input
                        type="number"
                        value={editingPrice.base_price}
                        onChange={(e) =>
                          setEditingPrice({
                            ...editingPrice,
                            base_price: parseFloat(e.target.value),
                          })
                        }
                        className="w-full px-3 py-2 border rounded-md text-sm"
                      />
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                      <div>
                        <label className="block text-sm font-medium mb-1">
                          Helg (x)
                        </label>
                        <input
                          type="number"
                          step="0.1"
                          value={editingPrice.weekend_multiplier}
                          onChange={(e) =>
                            setEditingPrice({
                              ...editingPrice,
                              weekend_multiplier: parseFloat(e.target.value),
                            })
                          }
                          className="w-full px-3 py-2 border rounded-md text-sm"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">
                          H√∂gtid (x)
                        </label>
                        <input
                          type="number"
                          step="0.1"
                          value={editingPrice.holiday_multiplier}
                          onChange={(e) =>
                            setEditingPrice({
                              ...editingPrice,
                              holiday_multiplier: parseFloat(e.target.value),
                            })
                          }
                          className="w-full px-3 py-2 border rounded-md text-sm"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">
                          S√§song (x)
                        </label>
                        <input
                          type="number"
                          step="0.1"
                          value={editingPrice.high_season_multiplier}
                          onChange={(e) =>
                            setEditingPrice({
                              ...editingPrice,
                              high_season_multiplier: parseFloat(
                                e.target.value
                              ),
                            })
                          }
                          className="w-full px-3 py-2 border rounded-md text-sm"
                        />
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => savePrice(editingPrice)}
                        className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-[#2c7a4c] text-white rounded-md hover:bg-[#236139] font-semibold text-sm"
                      >
                        <Save size={16} />
                        Spara
                      </button>
                      <button
                        onClick={() => setEditingPrice(null)}
                        className="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 font-semibold text-sm"
                      >
                        Avbryt
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* S√ÑSONGER */}
          <div>
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                  <Calendar className="text-[#2c7a4c]" size={20} />
                  S√§songer & H√∂gtider
                </h2>
                <button
                  onClick={() =>
                    setEditingSeason({
                      id: "",
                      org_id: "",
                      name: "",
                      start_date: "",
                      end_date: "",
                      type: "high",
                      created_at: "",
                    })
                  }
                  className="flex items-center gap-2 px-4 py-2 bg-[#2c7a4c] text-white rounded-md hover:bg-[#236139] transition-colors font-semibold text-sm"
                >
                  <Plus size={16} />
                  L√§gg till
                </button>
              </div>

              {seasons.length === 0 ? (
                <p className="text-gray-500 py-8 text-sm">
                  Inga s√§songer √§nnu. Klicka p√• "L√§gg till" f√∂r att skapa.
                </p>
              ) : (
                <div className="space-y-4">
                  {seasons.map((season) => (
                    <div
                      key={season.id}
                      className={`border rounded-lg p-4 hover:bg-gray-50 transition-colors ${
                        season.type === "holiday"
                          ? "border-red-200 bg-red-50"
                          : season.type === "high"
                            ? "border-yellow-200 bg-yellow-50"
                            : "border-blue-200 bg-blue-50"
                      }`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h3 className="font-semibold text-gray-900 text-sm">
                            {season.name}
                          </h3>
                          <p className="text-sm text-gray-600">
                            {new Date(season.start_date).toLocaleDateString(
                              "sv-SE"
                            )}{" "}
                            -{" "}
                            {new Date(season.end_date).toLocaleDateString(
                              "sv-SE"
                            )}
                          </p>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setEditingSeason(season)}
                            className="p-2 text-blue-600 hover:bg-blue-100 rounded-md"
                          >
                            <Edit2 size={16} />
                          </button>
                          <button
                            onClick={() => deleteSeason(season.id)}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-md"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      </div>
                      <span
                        className={`inline-block px-3 py-1 rounded-full text-xs font-semibold ${
                          season.type === "holiday"
                            ? "bg-red-200 text-red-800"
                            : season.type === "high"
                              ? "bg-yellow-200 text-yellow-800"
                              : "bg-blue-200 text-blue-800"
                        }`}
                      >
                        {season.type === "holiday"
                          ? "üéâ H√∂gtid"
                          : season.type === "high"
                            ? "‚òÄÔ∏è H√∂gs√§song"
                            : "‚ùÑÔ∏è L√•gs√§song"}
                      </span>
                    </div>
                  ))}
                </div>
              )}

              {/* Edit Form */}
              {editingSeason && (
                <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <h3 className="font-semibold mb-4 text-sm">
                    {editingSeason.id ? "Redigera s√§song" : "Ny s√§song"}
                  </h3>
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium mb-1">
                        Namn
                      </label>
                      <input
                        type="text"
                        value={editingSeason.name}
                        onChange={(e) =>
                          setEditingSeason({
                            ...editingSeason,
                            name: e.target.value,
                          })
                        }
                        placeholder="t.ex. Sommar 2025"
                        className="w-full px-3 py-2 border rounded-md text-sm"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="block text-sm font-medium mb-1">
                          Startdatum
                        </label>
                        <input
                          type="date"
                          value={editingSeason.start_date}
                          onChange={(e) =>
                            setEditingSeason({
                              ...editingSeason,
                              start_date: e.target.value,
                            })
                          }
                          className="w-full px-3 py-2 border rounded-md text-sm"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">
                          Slutdatum
                        </label>
                        <input
                          type="date"
                          value={editingSeason.end_date}
                          onChange={(e) =>
                            setEditingSeason({
                              ...editingSeason,
                              end_date: e.target.value,
                            })
                          }
                          className="w-full px-3 py-2 border rounded-md text-sm"
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">
                        Typ
                      </label>
                      <select
                        value={editingSeason.type}
                        onChange={(e) =>
                          setEditingSeason({
                            ...editingSeason,
                            type: e.target.value as "high" | "low" | "holiday",
                          })
                        }
                        className="w-full px-3 py-2 border rounded-md text-sm"
                      >
                        <option value="high">‚òÄÔ∏è H√∂gs√§song</option>
                        <option value="low">‚ùÑÔ∏è L√•gs√§song</option>
                        <option value="holiday">üéâ H√∂gtid</option>
                      </select>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => saveSeason(editingSeason)}
                        className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-[#2c7a4c] text-white rounded-md hover:bg-[#236139] font-semibold text-sm"
                      >
                        <Save size={16} />
                        Spara
                      </button>
                      <button
                        onClick={() => setEditingSeason(null)}
                        className="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 font-semibold text-sm"
                      >
                        Avbryt
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Info Box */}
        <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 className="font-bold text-blue-900 mb-3 text-sm">
            ‚ÑπÔ∏è Hur prisber√§kning fungerar
          </h3>
          <div className="space-y-2 text-sm text-blue-800">
            <p>
              <strong>1. Grundpris</strong> baseras p√• hundens mankh√∂jd:
            </p>
            <ul className="list-disc ml-6 space-y-1">
              <li>Liten (0-34 cm): 1.0x grundpris</li>
              <li>Mellan (35-49 cm): 1.2x grundpris</li>
              <li>Stor (50+ cm): 1.4x grundpris</li>
            </ul>
            <p className="mt-3">
              <strong>2. Till√§gg</strong> l√§ggs till per natt:
            </p>
            <ul className="list-disc ml-6 space-y-1">
              <li>
                <strong>Helg</strong>: L√∂rdagar och s√∂ndagar (t.ex. 1.2x = +20%)
              </li>
              <li>
                <strong>H√∂gtid</strong>: Definierade h√∂gtider (t.ex. 1.5x =
                +50%)
              </li>
              <li>
                <strong>H√∂gs√§song</strong>: Definierade s√§songer (t.ex. 1.3x =
                +30%)
              </li>
            </ul>
            <p className="mt-3">
              <strong>3. Rabatter</strong> dras av fr√•n totalsumman och baseras
              p√• √§garens rabattavtal (position_share).
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
